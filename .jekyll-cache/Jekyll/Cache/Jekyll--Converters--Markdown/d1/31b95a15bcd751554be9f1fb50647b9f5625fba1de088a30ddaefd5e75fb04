I"k¨<blockquote>
  <p>æœ¬æ–‡ä¸ºåŸåˆ›</p>
</blockquote>

<p><a href="https://zhuanlan.zhihu.com/p/49935908">å®éªŒä¸­æ–‡ç¿»è¯‘</a></p>

<h2 id="pcç‰©ç†åœ°å€ç©ºé—´">PCç‰©ç†åœ°å€ç©ºé—´</h2>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    +------------------+  &lt;- 0xFFFFFFFF (4GB)
    |      32-bit      |
    |  memory mapped   |
    |     devices      |
    |                  |
    /\/\/\/\/\/\/\/\/\/\

    /\/\/\/\/\/\/\/\/\/\
    |                  |
    |      Unused      |
    |                  |
    +------------------+  &lt;- depends on amount of RAM
    |                  |
    |                  |
    | Extended Memory  |
    |                  |
    |                  |
    +------------------+  &lt;- 0x00100000 (1MB)
    |     BIOS ROM     |
    +------------------+  &lt;- 0x000F0000 (960KB)
    |  16-bit devices, |
    |  expansion ROMs  |
    +------------------+  &lt;- 0x000C0000 (768KB)
    |   VGA Display    |
    +------------------+  &lt;- 0x000A0000 (640KB)
    |                  |
    |    Low Memory    |
    |                  |
    +------------------+  &lt;- 0x00000000
</code></pre></div></div>

<p>ç¬¬ä¸€ä»£åŸºäº16ä½Intel 8088å¤„ç†å™¨çš„PCä»…èƒ½å¤Ÿä½¿ç”¨1MBçš„ç‰©ç†å†…å­˜ã€‚å› æ­¤ï¼Œæ—©æœŸPCçš„ç‰©ç†åœ°å€ç©ºé—´å°†ä»0x00000000å¼€å§‹ï¼Œåˆ°0x000FFFFFç»“æŸï¼Œè€Œä¸æ˜¯0xFFFFFFFFã€‚æ ‡æœ‰â€œLow Memoryâ€çš„640KBåŒºåŸŸæ˜¯æ—©æœŸPCå¯ä»¥ä½¿ç”¨çš„å”¯ä¸€çš„éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRAMï¼‰; äº‹å®ä¸Šï¼Œæœ€æ—©çš„PCåªèƒ½é…ç½®16KBï¼Œ32KBæˆ–64KBçš„RAMï¼</p>

<p>ä»0x000A0000åˆ°0x000FFFFFçš„384KBåŒºåŸŸç”±ç¡¬ä»¶ä¿ç•™ç”¨äºç‰¹æ®Šç”¨é€”ï¼Œä¾‹å¦‚è§†é¢‘æ˜¾ç¤ºç¼“å†²åŒºå’Œå›ºä»¶çš„éæ˜“å¤±æ€§å­˜å‚¨ã€‚è¿™äº›ä¿ç•™åŒºåŸŸæœ€é‡è¦çš„éƒ¨åˆ†æ˜¯BIOSï¼Œå®ƒå ç”¨äº†ä»0x000F0000åˆ°0x000FFFFFçš„64KBåŒºåŸŸã€‚æ—©æœŸçš„PCæŠŠBIOSä¿å­˜åœ¨çœŸæ­£çš„åªè¯»å­˜å‚¨å™¨ï¼ˆROMï¼‰ä¸­ï¼Œä½†æ˜¯ç°åœ¨çš„PCå°†BIOSå­˜å‚¨åœ¨å¯æ›´æ–°çš„é—ªå­˜ä¸­ã€‚BIOSè´Ÿè´£æ‰§è¡ŒåŸºæœ¬çš„ç³»ç»Ÿåˆå§‹åŒ–ï¼Œä¾‹å¦‚æ¿€æ´»æ˜¾å¡å’Œæ£€æŸ¥å®‰è£…çš„å†…å­˜å®¹é‡ã€‚æ‰§è¡Œæ­¤åˆå§‹åŒ–åï¼ŒBIOSä»æŸäº›é€‚å½“çš„ä½ç½®ï¼ˆå¦‚è½¯ç›˜ï¼Œç¡¬ç›˜ï¼ŒCD-ROMæˆ–ç½‘ç»œï¼‰åŠ è½½æ“ä½œç³»ç»Ÿï¼Œå¹¶å°†æœºå™¨çš„æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿã€‚</p>

<p>Intelçš„80286å’Œ80386å¤„ç†å™¨çªç ´äº†1Mbçš„å†…å­˜å¤§å°ï¼Œå¹¶ä¸”å®ƒä»¬åˆ†åˆ«æ”¯æŒ16MBå’Œ4GBç‰©ç†åœ°å€ç©ºé—´çš„ï¼Œä½†æ˜¯ä»ç„¶ä¿ç•™äº†åŸæœ‰çš„ä½1MBç‰©ç†åœ°å€ç©ºé—´å¸ƒå±€ï¼Œä»¥ç¡®ä¿å‘åå…¼å®¹è½¯ä»¶ã€‚å› æ­¤ï¼Œç°ä»£PCåœ¨ç‰©ç†å†…å­˜ä¸­æœ‰ä¸€ä¸ªâ€œç©ºæ´â€ï¼Œä»0x000A0000åˆ°0x00100000ï¼Œå®ƒå°†RAMåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯â€œLowâ€æˆ–ç€å«ä½œâ€œconventional memoryâ€ï¼Œè¿™ä¸€å—å°±æ˜¯å†…å­˜èµ·å§‹çš„å‰640KBï¼Œå¦ä¸€ä¸ªæ˜¯â€œextended memoryâ€ï¼ˆå…¶ä»–æ‰€æœ‰å‰©ä½™å®¹é‡ï¼‰ã€‚æ­¤å¤–ï¼ŒPCçš„32ä½ç‰©ç†åœ°å€ç©ºé—´é¡¶éƒ¨çš„ä¸€äº›ç©ºé—´ï¼Œé€šå¸¸ç”±BIOSä¿ç•™ï¼Œä¾›32ä½PCIè®¾å¤‡ä½¿ç”¨ã€‚</p>

<h2 id="å®æ¨¡å¼">å®æ¨¡å¼</h2>

<p>åœ¨å®æ¨¡å¼ä¸‹ï¼Œå†…å­˜è¢«é™åˆ¶ä¸ºä»…ä¸€å…†å­—èŠ‚ï¼ˆ220å­—èŠ‚ï¼‰ã€‚ æœ‰æ•ˆåœ°å€èŒƒå›´æ˜¯ï¼ˆåå…­è¿›åˆ¶ï¼‰00000è‡³FFFFFã€‚ è¿™äº›åœ°å€éœ€è¦ä¸€ä¸ª20ä½æ•°å­—ã€‚ æ˜¾ç„¶ï¼Œ8086çš„ä»»ä½•16ä½å¯„å­˜å™¨éƒ½æ— æ³•å®¹çº³20ä½æ•°å­—ã€‚ è‹±ç‰¹å°”é€šè¿‡ä½¿ç”¨ä¸¤ä¸ª16ä½å€¼ç¡®å®šä¸€ä¸ªåœ°å€æ¥è§£å†³æ­¤é—®é¢˜ã€‚ ç¬¬ä¸€ä¸ª16ä½å€¼ç§°ä¸ºselectorã€‚selectorçš„å€¼å¿…é¡»å­˜å‚¨åœ¨æ®µå¯„å­˜å™¨ä¸­ã€‚ ç¬¬äºŒä¸ª16ä½å€¼ç§°ä¸ºoffsetã€‚ ç”±ä¸€å¯¹32ä½çš„<code class="language-plaintext highlighter-rouge">selectorï¼šoffset</code>æ¥å¼•ç”¨çš„ç‰©ç†åœ°å€ï¼Œç‰©ç†åœ°å€ç”±ä»¥ä¸‹å…¬å¼è®¡ç®—</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>16 âˆ— selector + offset
</code></pre></div></div>

<p>ç”¨åå…­è¿›åˆ¶ä¹˜ä»¥16å¾ˆå®¹æ˜“ï¼Œåªéœ€åœ¨æ•°å­—çš„å³è¾¹æ·»åŠ ä¸€ä¸ª0ã€‚ä¾‹å¦‚ï¼Œç”±047Cï¼š0048å¼•ç”¨çš„ç‰©ç†åœ°å€ç”±ä¸‹å¼ç»™å‡ºï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  047C0
  +0048
â€”â€”â€”â€”â€”â€”â€”â€”
  04808
</code></pre></div></div>

<p>å®é™…ä¸Šï¼Œselectorçš„å€¼æ˜¯ä¸€ä¸ªæ®µè½å·</p>

<p>è¿™ä¸ªåˆ†æ®µåœ°å€æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š</p>

<ul>
  <li>
    <p>ä¸€ä¸ªselectorçš„å€¼åªèƒ½å¼•ç”¨64Kå†…å­˜ï¼ˆ16ä½åç§»çš„é™åˆ¶ï¼‰ã€‚ å¦‚æœç¨‹åºæœ‰64Kä»¥ä¸Šçš„ä»£ç ï¼Ÿ CSå¯„å­˜å™¨ä¸­çš„å€¼å°±ä¸èƒ½ç”¨äºè¯¥ç¨‹åºçš„æ•´ä¸ªæ‰§è¡Œã€‚ è¯¥ç¨‹åºå¿…é¡»åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼ˆç§°ä¸ºæ®µï¼‰ï¼Œæ¯ä¸ªéƒ¨åˆ†çš„å¤§å°å°äº64Kã€‚ å½“æ‰§è¡Œä»ä¸€ä¸ªæ®µç§»åˆ°å¦ä¸€ä¸ªæ®µæ—¶ï¼Œå¿…é¡»æ›´æ”¹CSçš„å€¼ã€‚ ç±»ä¼¼é—®é¢˜
åœ¨æœ‰å¤§é‡æ•°æ®å’ŒDSå¯„å­˜å™¨ä¸­å‘ç”Ÿã€‚</p>
  </li>
  <li>
    <p>å†…å­˜ä¸­çš„æ¯ä¸ªå­—èŠ‚æ²¡æœ‰å”¯ä¸€çš„åˆ†æ®µåœ°å€ã€‚ç‰©ç†åœ°å€04808å¯ä»¥ç”±047Cï¼š0048ã€047Dï¼š0038ã€047Eï¼š0028æˆ–047Bï¼š0058å¼•ç”¨ã€‚ è¿™ä¼šä½¿åˆ†æ®µåœ°å€çš„æ¯”è¾ƒå˜å¤æ‚ã€‚</p>
  </li>
</ul>

<h2 id="16ä½ä¿æŠ¤æ¨¡å¼">16ä½ä¿æŠ¤æ¨¡å¼</h2>

<p>åœ¨80286çš„16ä½ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œselectorçš„å€¼çš„è§£é‡Šä¸å®æ¨¡å¼å®Œå…¨ä¸åŒã€‚åœ¨å®æ¨¡å¼ä¸‹ï¼Œselectorçš„å€¼æ˜¯ç‰©ç†å†…å­˜çš„æ®µè½ç¼–å·ã€‚ åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œselectorçš„å€¼æ˜¯æè¿°ç¬¦è¡¨çš„ç´¢å¼•ã€‚åœ¨ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œç¨‹åºéƒ½æ˜¯è¢«åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ã€‚åœ¨å®æ¨¡å¼ä¸‹ï¼Œè¿™äº›æ®µä½äºç‰©ç†å†…å­˜ä¸­çš„å›ºå®šä½ç½®
ï¼Œselectorçš„å€¼è¡¨ç¤ºè¯¥æ®µçš„å¼€å¤´çš„æ®µè½ç¼–å·ã€‚åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ®µä¸æ˜¯åœ¨ç‰©ç†å†…å­˜ä¸­çš„å›ºå®šä½ç½®ã€‚å®é™…ä¸Šï¼Œæ®µä¸ä¸€å®šåœ¨å†…å­˜ä¸­ï¼</p>

<p>ä¿æŠ¤æ¨¡å¼ä½¿ç”¨ä¸€ç§è™šæ‹Ÿå†…å­˜çš„æŠ€æœ¯ã€‚åŸºæœ¬æ€è·¯è™šæ‹Ÿå†…å­˜ç³»ç»Ÿçš„åŠŸèƒ½æ˜¯ä»…å°†æ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„æ•°æ®å’Œä»£ç ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œè€Œå…¶ä»–æ•°æ®å’Œä»£ç è¢«ä¸´æ—¶å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œç›´åˆ°å†æ¬¡è¿è¡Œå®ƒä»¬ä¸ºæ­¢ã€‚</p>

<p>åœ¨16ä½ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ®µä¼šæ ¹æ®éœ€è¦åœ¨å†…å­˜å’Œç£ç›˜ä¹‹é—´ç§»åŠ¨ã€‚æ®µä»ç£ç›˜å­˜å‚¨è¿”å›åˆ°å†…å­˜æ—¶ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå°†å…¶æ”¾ç½®åœ¨å…¶ä»–åŒºåŸŸã€‚æ‰€æœ‰è¿™äº›éƒ½ç”±æ“ä½œç³»ç»Ÿå®Œæˆã€‚</p>

<p>åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œåœ¨æè¿°ç¬¦è¡¨ä¸­ä¸ºæ¯ä¸ªæ®µåˆ†é…äº†ä¸€ä¸ªæ¡ç›®ã€‚è¿™ä¸ªæ¡ç›®å…·æœ‰ç³»ç»Ÿéœ€è¦çŸ¥é“çš„æ®µçš„æ‰€æœ‰ä¿¡æ¯ã€‚è¯¥ä¿¡æ¯åŒ…æ‹¬ï¼šå½“å‰æ˜¯å¦åœ¨å†…å­˜ä¸­ï¼›
å¦‚æœåœ¨å†…å­˜ä¸­ï¼Œå®ƒåœ¨å“ªé‡Œï¼›è®¿é—®æƒé™ï¼ˆä¾‹å¦‚ï¼Œåªè¯»ï¼‰ã€‚ selectorçš„å€¼å°±æ˜¯ç”¨äºåœ¨æè¿°ç¬¦è¡¨ä¸­å¯»æ‰¾æ¡ç›®çš„ç´¢å¼•å€¼ã€‚</p>

<p>16ä½ä¿æŠ¤æ¨¡å¼çš„ä¸€å¤§ç¼ºç‚¹æ˜¯åç§»é‡ä»ä¸º16ä½ã€‚ ç»“æœï¼Œæ®µå¤§å°ä»ç„¶é™åˆ¶ä¸ºæœ€å¤§64Kã€‚ è¿™ä½¿å¾—ä½¿ç”¨å¤§å‹é˜µåˆ—æˆä¸ºé—®é¢˜ï¼</p>

<h2 id="32ä½ä¿æŠ¤æ¨¡å¼">32ä½ä¿æŠ¤æ¨¡å¼</h2>

<p>80386å¼•å…¥äº†32ä½ä¿æŠ¤æ¨¡å¼ã€‚386 32ä½å’Œ286 16ä½ä¿æŠ¤æ¨¡å¼ä¹‹é—´æœ‰ä¸¤ä¸ªä¸»è¦åŒºåˆ«ï¼š</p>

<ol>
  <li>
    <p>åç§»é‡æ‰©å±•ä¸º32ä½ã€‚è¿™å…è®¸åç§»èŒƒå›´æ‰©å¤§åˆ°40äº¿ã€‚ å› æ­¤ï¼Œæ®µçš„æœ€å¤§å¤§å°ä¸º4 GBã€‚</p>
  </li>
  <li>
    <p>æ®µå¯ä»¥è¢«åˆ†æˆå¤§å°ä¸º4Kçš„é¡µã€‚è™šæ‹Ÿå†…å­˜ç³»ç»Ÿç°åœ¨å¯ä»¥å¤„ç†é¡µé¢è€Œä¸æ˜¯æ®µã€‚
è¿™æ„å‘³ç€ï¼Œåœ¨ä»»ä½•æ—¶é—´é‡Œï¼Œä¸€ä¸ªæ®µå¯èƒ½åªæœ‰ä¸€éƒ¨åˆ†åœ¨å†…å­˜ä¸­ã€‚åœ¨286çš„16ä½æ¨¡å¼ä¸‹ï¼Œæ•´ä¸ªæ®µéƒ½åœ¨å†…å­˜ä¸­æˆ–éƒ½ä¸åœ¨ã€‚å¯¹äº32ä½çš„è¾ƒå¤§æ®µï¼Œè¿™æ˜¯ä¸åˆ‡å®é™…çš„ã€‚</p>
  </li>
</ol>

<h2 id="boot-loader">Boot Loader</h2>

<p>BIOSå°†å¯åŠ¨æ‰‡åŒºåŠ è½½åˆ°ç‰©ç†åœ°å€0x7c00è‡³0x7dffè¿™ä¸ªåŒºé—´ã€‚åœ¨6.828ä¸­,boot loader ä¸»è¦å®Œæˆä¸¤ä¸ªå·¥ä½œï¼Œä¸€ä¸ªæ˜¯å°†å®æ¨¡å¼è½¬æ¢åˆ°ä¿æŠ¤æ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯åŠ è½½joså†…æ ¸ã€‚</p>

<ol>
  <li>
    <p>å°†å¯„å­˜å™¨ cr0 çš„ç¬¬ä¸€ä½ä¸º1ç½®ä¸º1,å³å¯å¼€å¯ä¿æŠ¤æ¨¡å¼,ä¸»è¦ä»£ç å¦‚ä¸‹:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">.</span><span class="n">set</span> <span class="n">CR0_PE_ON</span><span class="p">,</span>      <span class="mh">0x1</span>         <span class="err">#</span> <span class="n">protected</span> <span class="n">mode</span> <span class="n">enable</span> <span class="n">flag</span>
</code></pre></div>    </div>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">lgdt</span>    <span class="n">gdtdesc</span>
 <span class="n">movl</span>    <span class="o">%</span><span class="n">cr0</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
 <span class="n">orl</span>     <span class="err">$</span><span class="n">CR0_PE_ON</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
 <span class="n">movl</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span> <span class="o">%</span><span class="n">cr0</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åŠ è½½å†…æ ¸çš„ç¬¬ä¸€æ­¥æ˜¯,å°† kernel åŠ è½½åˆ°ä¸€ä¸ªpageä¸­,è¿™ä¸ªpageæ˜¯4kçš„å¤§å°,è€Œä¸”æœ‰ä¸€ä¸ªelfæ ¼å¼çš„ç»“æ„ä½“æŒ‡é’ˆ(ELFHDR)æŒ‡å‘è¿™ä¸ªpageçš„é¦–åœ°å€.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cp">#define ELFHDR    ((struct Elf *) 0x10000) // scratch space
</span></code></pre></div>    </div>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// read 1st page off disk (4k)</span>
 <span class="n">readseg</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">ELFHDR</span><span class="p">,</span> <span class="n">SECTSIZE</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>ç„¶åæ ¹æ®é­”æ•°åˆ¤æ–­kernelçš„elfæ ¼å¼æ˜¯å¦æ­£ç¡®.æ¥ä¸‹æ¥å°†æ ¹æ®ELFHDRæŒ‡é’ˆçš„<code class="language-plaintext highlighter-rouge">e_phoff</code>æ‰¾åˆ°program header tableçš„é¦–åœ°å€,ç„¶åæ ¹æ®tableä¸­çš„æ¡ç›®åŠ è½½ç›¸åº”çš„ç¨‹åº.</p>

<p>ä¸»è¦ä»£ç å¦‚ä¸‹:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// load each program segment (ignores ph flags),e_phoff(program header table offset)</span>
<span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Proghdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ELFHDR</span> <span class="o">+</span> <span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
<span class="n">eph</span> <span class="o">=</span> <span class="n">ph</span> <span class="o">+</span> <span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(;</span> <span class="n">ph</span> <span class="o">&lt;</span> <span class="n">eph</span><span class="p">;</span> <span class="n">ph</span><span class="o">++</span><span class="p">)</span>
    <span class="c1">// p_pa is the load address of this segment (as well</span>
    <span class="c1">// as the physical address)</span>
    <span class="n">readseg</span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_pa</span><span class="p">,</span> <span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">,</span> <span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="exercise-3">Exercise 3</h2>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>åœ¨æ‰§è¡Œå®Œ<code class="language-plaintext highlighter-rouge">movl %eax, %cr0</code>ä¹‹å,ä¿æŠ¤æ¨¡å¼è¢«å¼€å¯,32-bitçš„codeå°±å¯ä»¥æ‰§è¡Œäº†,cr0å¯„å­˜å™¨çš„ç¬¬ä¸€ä½ç½®ä¸º1,å°±æ˜¯å¼€å¯äº†ä¿æŠ¤æ¨¡å¼.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2. What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?
</code></pre></div></div>

<p>è§£ç­”:</p>

<p><code class="language-plaintext highlighter-rouge">call *0x10018</code>æ˜¯boot loaderæ‰§è¡Œçš„æœ€åçš„ä»£ç ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹boot loaderåç¼–è¯‘çš„<code class="language-plaintext highlighter-rouge">boot.asm</code>å¾—åˆ°.</p>

<p><code class="language-plaintext highlighter-rouge">movw $0x1234,0x472</code>æ˜¯å†…æ ¸æ‰§è¡Œçš„ç¬¬ä¸€è¡Œä»£ç ã€‚</p>

<p>åˆ†æï¼š</p>

<p><code class="language-plaintext highlighter-rouge">objdump -x obj/kern/kernel</code></p>

<p>åæ±‡ç¼–å†…æ ¸ä»£ç ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹å†…æ ¸çš„ç¬¬ä¸€è¡Œä»£ç çš„ä½ç½®ï¼Œç„¶ååœ¨<code class="language-plaintext highlighter-rouge">0x10000c</code>å¤„è®¾ç½®æ–­ç‚¹ï¼Œè¿è¡Œåˆ°æ­¤å¤„å³å¯å¾—åˆ°å†…æ ¸çš„ç¬¬ä¸€è¡Œä»£ç </p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3. Where is the first instruction of the kernel?
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>å†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„ç‰©ç†åœ°å€ä¸º0x10000c</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4. How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information?
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>elf header ä¸­æœ‰æä¾›å†…æ ¸å¤§å°</p>

<h2 id="exercise-5">Exercise 5</h2>

<p>è§£ç­”:</p>

<p>å°†Makefragæ–‡ä»¶ä¸­çš„-Ttextçš„å‚æ•°ä¿®æ”¹ä¸º0x7c01ï¼Œç„¶åå†è°ƒè¯•ï¼Œä¼šå‘ç°qemuåœ¨åå¤è¯»å–å†…æ ¸ã€‚å…¶å®å†…æ ¸åŠ è½½ä¼šæˆåŠŸï¼Œä½†æ˜¯åœ¨æ›¿æ¢ç¨‹åºçš„ç¬¦åˆå¼•ç”¨æ—¶ï¼Œä¼šå‡ºé”™ã€‚</p>

<h2 id="exercise-7">Exercise 7</h2>

<p>è§£ç­”:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Load the physical address of entry_pgdir into cr3.  entry_pgdir
# is defined in entrypgdir.c.è¿™æ˜¯ä¸€ä¸ªæœ‰å±€é™çš„é¡µç›®å½•,åªèƒ½æ˜ å°„[KERNBASE, KERNBASE+4MB)
# é¡µç›®å½•çš„ç‰©ç†åœ°å€è¢«å­˜æ”¾åœ¨cr3ä¸­,cr0çš„PE,PG,WPä½ç½®1,åˆ†åˆ«ä»£è¡¨å¼€å¯ä¿æŠ¤,å¼€å¯åˆ†é¡µ,å¼€å¯å†™ä¿æŠ¤
movl    $(RELOC(entry_pgdir)), %eax
movl    %eax, %cr3
# Turn on paging.
movl    %cr0, %eax
orl     $(CR0_PE|CR0_PG|CR0_WP), %eax
movl    %eax, %cr0
</code></pre></div></div>

<p>å› ä¸º<code class="language-plaintext highlighter-rouge">movl %eax,%cr0</code>ä¼šå¼€å¯é¡µè¡¨ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰æ‰§è¡Œè¿™æ¡æŒ‡ä»¤çš„æ—¶å€™ï¼Œ0xf0100000å¤„æ˜¯æ²¡æœ‰å†…å®¹çš„ï¼Œè€Œ0x00100000å¤„æœ‰å†…å®¹ã€‚å½“æ‰§è¡Œè¿™æ¡æŒ‡ä»¤åï¼Œé¡µè¡¨å¼€å¯ï¼Œè™šæ‹Ÿé«˜åœ°å€å°†æ˜ å°„åˆ°ç‰©ç†ä½åœ°å€ï¼Œæ‰€ä»¥0xf0100000å’Œ0x00100000å¤„çš„å†…å®¹ç›¸åŒï¼Œå› ä¸ºï¼Œè™šæ‹Ÿä½åœ°å€åŒæ ·ä¼šæ˜ å°„åˆ°ç‰©ç†ä½åœ°å€ã€‚</p>

<p>å¦‚æœæ³¨é‡Šæ‰ï¼Œç»“æœå¾ˆæ˜æ˜¾ã€‚ç”±äºæ²¡æœ‰å¼€å¯åˆ†é¡µï¼Œå¯¼è‡´åé¢çš„è·³è½¬æŒ‡ä»¤å‡ºé”™ã€‚</p>

<h2 id="exercise-8">Exercise 8</h2>

<p>å®éªŒå¼€å§‹å‰,å…ˆæ¥ä¸€æ³¢åˆ†æ.</p>

<p>I/Oåˆ†æ:
<code class="language-plaintext highlighter-rouge">int cprintf(const char *fmt, ...);</code>è¿™æ˜¯<code class="language-plaintext highlighter-rouge">inc/stdio.h</code>ä¸­å®šä¹‰çš„è¾“å‡ºå‡½æ•°,å‡½æ•°cprintfåœ¨<code class="language-plaintext highlighter-rouge">kern/print.c</code>ä¸­å®ç°,ä»£ç å¦‚ä¸‹:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">cprintf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

    <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">vcprintf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç ä¸­ä¼šè°ƒç”¨ä¸‰ä¸ªå‡½æ•°<code class="language-plaintext highlighter-rouge">va_start</code>,<code class="language-plaintext highlighter-rouge">vcprintf</code>å’Œ<code class="language-plaintext highlighter-rouge">va_end</code>,å…¶ä¸­<code class="language-plaintext highlighter-rouge">va_start</code>å’Œ<code class="language-plaintext highlighter-rouge">va_end</code>æ˜¯åœ¨<code class="language-plaintext highlighter-rouge">inc/stdarg.h</code>åœ¨å®šä¹‰çš„,å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/pengdonglin137/p/3345911.html">è¿™é‡Œ</a>.vcprintfå‡½æ•°æ˜¯åœ¨<code class="language-plaintext highlighter-rouge">kern/print.c</code>ä¸­å®ç°çš„,vcprintfä»£ç å®ç°å¦‚ä¸‹:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int
vcprintf(const char *fmt, va_list ap)
{
    int cnt = 0;

    vprintfmt((void*)putch, &amp;cnt, fmt, ap);
    return cnt;
}
</code></pre></div></div>

<p>å¾ˆæ˜æ˜¾,cntæ˜¯ç”¨æ¥è®¡é‡å®é™…è¾“å‡ºå­—ç¬¦çš„,ç„¶åè°ƒç”¨<code class="language-plaintext highlighter-rouge">lib/printfmt.c</code>ä¸­å®šä¹‰çš„vprintfmtå‡½æ•°æ¥å®ç°è¾“å‡ºæ•°æ®æ ¼å¼åŒ–,ç„¶ååœ¨vprintfmtå‡½æ•°å†…éƒ¨è°ƒç”¨<code class="language-plaintext highlighter-rouge">printnum</code>å‡½æ•°,<code class="language-plaintext highlighter-rouge">printnum</code>å‡½æ•°åˆè°ƒç”¨<code class="language-plaintext highlighter-rouge">putch</code>å‡½æ•°,ç„¶å<code class="language-plaintext highlighter-rouge">putch</code>å‡½æ•°ç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„è¿‡ç¨‹å°†æ•°æ®è¾“å‡º.å±å¹•æ‰“å°å¯ä»¥æŸ¥çœ‹ç‹çˆ½çš„ã€Šæ±‡ç¼–è¯­è¨€ã€‹,å‘å†…å­˜åœ°å€0xb8000è¾“å…¥å³å¯æ‰“å°è‡³å±å¹•ã€‚</p>

<p>å®éªŒå¼€å§‹:</p>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="sc">'o'</span><span class="p">:</span>
    <span class="c1">// Replace this with your code.</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">getuint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="p">,</span> <span class="n">lflag</span><span class="p">);</span>
    <span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">number</span><span class="p">;</span>
</code></pre></div></div>

<p>Be able to answer the following questions:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Explain the interface between printf.c and console.c. Specifically, what function does console.c export? How is this function used by printf.c?
</code></pre></div></div>

<p>è§£ç­”:</p>

<ul>
  <li>
    <p>cputcharï¼Œæ‰“å°ä¸€ä¸ªå•ä¸€çš„å­—ç¬¦</p>
  </li>
  <li>
    <p>åœ¨printf.cä¸­ï¼Œç”±äºprintfä¸­çš„argsæ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨va_listå’Œæ ¼å¼å­—ç¬¦ä¸²æ¥ç¡®å®šå‚æ•°æ•°é‡ã€‚cprintfï¼ˆï¼‰å°†è°ƒç”¨vcprintfï¼ˆï¼‰ï¼Œåè€…å°†è°ƒç”¨vprintfmtï¼Œvprintfmt()å°†è§£ææ ¼å¼å­—ç¬¦ä¸²å¹¶è¯»å…¥ï¼ˆä½¿ç”¨va_listï¼‰å‚æ•°ï¼Œå¹¶å°†å…¶è¾“å‡ºåˆ°å±å¹•ï¼ˆä½¿ç”¨console.cç»™å‡ºçš„cputcharï¼‰ã€‚</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2</span><span class="p">.</span><span class="err">ã€€</span><span class="n">Explain</span> <span class="n">the</span> <span class="n">following</span> <span class="n">from</span> <span class="n">console</span><span class="p">.</span><span class="n">c</span><span class="o">:</span>
<span class="mi">1</span>      <span class="nf">if</span> <span class="p">(</span><span class="n">crt_pos</span> <span class="o">&gt;=</span> <span class="n">CRT_SIZE</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2</span>          <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="mi">3</span>          <span class="n">memmove</span><span class="p">(</span><span class="n">crt_buf</span><span class="p">,</span> <span class="n">crt_buf</span> <span class="o">+</span> <span class="n">CRT_COLS</span><span class="p">,</span> <span class="p">(</span><span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
<span class="mi">4</span>          <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CRT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="mi">5</span>              <span class="n">crt_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0700</span> <span class="o">|</span> <span class="sc">' '</span><span class="p">;</span>
<span class="mi">6</span>          <span class="n">crt_pos</span> <span class="o">-=</span> <span class="n">CRT_COLS</span><span class="p">;</span>
<span class="mi">7</span>      <span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">crt_pos</span> <span class="o">&gt;=</span> <span class="n">CRT_SIZE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//åˆ¤æ–­å±å¹•æ˜¯å¦å·²ç»æ‰“å°æ»¡äº†ï¼Œéœ€è¦å‘ä¸Šæ»šåŠ¨ä¸€è¡Œ</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">memmove</span><span class="p">(</span><span class="n">crt_buf</span><span class="p">,</span> <span class="n">crt_buf</span> <span class="o">+</span> <span class="n">CRT_COLS</span><span class="p">,</span> <span class="p">(</span><span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>   <span class="c1">//æ¯è¡Œå‘ä¸Šæ»šåŠ¨</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CRT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">//æœ€åä¸€è¡Œæ‰“å°ç©ºæ ¼ï¼Œç­‰äºæ¸…é™¤ä¸€è¡Œ</span>
        <span class="n">crt_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0700</span> <span class="o">|</span> <span class="sc">' '</span><span class="p">;</span>
    <span class="n">crt_pos</span> <span class="o">-=</span> <span class="n">CRT_COLS</span><span class="p">;</span><span class="c1">//å…‰æ ‡ç§»è‡³æœ€åä¸€è¡Œçš„ç¬¬ä¸€åˆ—</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3. For the following questions you might wish to consult the notes for Lecture 2. These notes cover GCC's calling convention on the x86.
Trace the execution of the following code step-by-step:

int x = 1, y = 3, z = 4;
cprintf("x %d, y %x, z %d\n", x, y, z);

In the call to cprintf(), to what does fmt point? To what does ap point?

List (in order of execution) each call to cons_putc, va_arg, and vcprintf. For cons_putc, list its argument as well. For va_arg, list what ap points to before and after the call. For vcprintf list the values of its two arguments.
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>fmtæŒ‡å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²â€x %d, y %x, z %d\nâ€ï¼ŒapæŒ‡å‘ç¬¬ä¸€ä¸ªè¦æ‰“å°çš„å‚æ•°çš„å†…å­˜åœ°å€ï¼Œä¹Ÿå°±æ˜¯xçš„åœ°å€ã€‚</p>

<p>è¿™ä¸ªå¯ä»¥é€šè¿‡ç›´æ¥é˜…è¯»æºç å¾—å‡ºç»“æœ,ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://jiyou.github.io/blog/2018/04/15/mit.6.828/jos-lab1/">è¿™é‡Œ</a></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4. Run the following code.
    unsigned int i = 0x00646c72;
    cprintf("H%x Wo%s", 57616, &amp;i);
What is the output? Explain how this output is arrived at in the step-by-step manner of the previous exercise. Here's an ASCII table that maps bytes to characters.
The output depends on that fact that the x86 is little-endian. If the x86 were instead big-endian what would you set i to in order to yield the same output? Would you need to change 57616 to a different value?

Here's a description of little- and big-endian and a more whimsical description.
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>è¾“å‡ºä¸ºhello world.è¿™ä¸ªå¯ä»¥ç›´æ¥åŠ å…¥å†…æ ¸æ‰“å°,ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/wuhualong/p/lab01_exercise08_formatted_printing_to_the_console.html">è¿™é‡Œ</a></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5. In the following code, what is going to be printed after 'y='? (note: the answer is not a specific value.) Why does this happen?
    cprintf("x=%d y=%d", 3);
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>è¿™ç§æ ˆè¶Šç•Œæ“ä½œï¼Œå…¶å®æ˜¯æ— æ³•åˆ¤å®šçš„ã€‚å› ä¸ºä¸çŸ¥é“è¶Šç•Œè¿™ä¸ªå†…å­˜é‡Œé¢ä»¥å‰æ”¾çš„å†…å®¹æ˜¯ä»€ä¹ˆã€‚</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6. Let's say that GCC changed its calling convention so that it pushed arguments on the stack in declaration order, so that the last argument is pushed last. How would you have to change cprintf or its interface so that it would still be possible to pass it a variable number of arguments?
</code></pre></div></div>

<p>è¿™ä¸ªå¯ä»¥é€šè¿‡ç›´æ¥é˜…è¯»æºç å¾—å‡ºç»“æœ,ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/wuhualong/p/lab01_exercise08_formatted_printing_to_the_console.html">è¿™é‡Œ</a>,ä»–æä¾›äº†ä¸¤ç§æ–¹æ³•,ç¬¬ä¸€ç§æˆ‘ä¸æ˜¯å¾ˆæ˜ç™½.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Challenge Enhance the console to allow text to be printed in different colors. The traditional way to do this is to make it interpret ANSI escape sequences embedded in the text strings printed to the console, but you may use any mechanism you like. There is plenty of information on the 6.828 reference page and elsewhere on the web on programming the VGA display hardware. If you're feeling really adventurous, you could try switching the VGA hardware into a graphics mode and making the console draw text onto the graphical frame buffer.
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>æ—¶éš”åŠå¹´ç»ˆäºä¼šäº†ï¼Œåœ¨ç‹çˆ½çš„æ±‡ç¼–è¯­è¨€ä¸­ï¼Œå¤§éƒ¨åˆ†å®éªŒéƒ½æ˜¯ä¸å±å¹•æ‰“å°ç›¸å…³ï¼Œä¸€ä¸ªå­—ç¬¦åœ¨æ±‡ç¼–å±‚ä¸­å ä¸¤ä¸ªå­—èŠ‚ï¼Œé«˜ä½ä¸é¢œè‰²ç›¸å…³ï¼Œä½ä½æ˜¯å­—ç¬¦ã€‚æˆ‘åœ¨console.cä¸­çš„cga_putc(int c)å‡½æ•°ä¸­æ‰§è¡Œäº†ä¸€æ¡â€™c</td>
      <td>0x2000â€™è¯­å¥,æ‰“å°å‡ºç»¿è‰²èƒŒæ™¯ç™½è‰²çš„å­—ä½“äº†:</td>
    </tr>
  </tbody>
</table>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">default:</span>
    <span class="n">crt_buf</span><span class="p">[</span><span class="n">crt_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">;</span>    <span class="cm">/* write the character */</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="exercise-9">Exercise 9</h2>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Exercise 9. Determine where the kernel initializes its stack, and exactly where in memory its stack is located. How does the kernel reserve space for its stack? And at which "end" of this reserved area is the stack pointer initialized to point to?
</code></pre></div></div>

<p>è§£ç­”:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp"># Set the stack pointer
</span><span class="n">movl</span>     <span class="err">$</span><span class="p">(</span><span class="n">bootstacktop</span><span class="p">),</span><span class="o">%</span><span class="n">esp</span>
<span class="n">f0100034</span><span class="o">:</span>    <span class="n">bc</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">11</span> <span class="n">f0</span>      <span class="n">mov</span>    <span class="err">$</span><span class="mh">0xf0110000</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
</code></pre></div></div>

<h2 id="exercise-10">Exercise 10</h2>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Exercise 10. To become familiar with the C calling conventions on the x86, find the address of the test_backtrace function in obj/kern/kernel.asm, set a breakpoint there, and examine what happens each time it gets called after the kernel starts. How many 32-bit words does each recursive nesting level of test_backtrace push on the stack, and what are those words?

Note that, for this exercise to work properly, you should be using the patched version of QEMU available on the tools page or on Athena. Otherwise, you'll have to manually translate all breakpoint and memory addresses to linear addresses.
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>gdbè°ƒè¯•å¯ä»¥å‚è€ƒ<a href="https://wizardforcel.gitbooks.io/100-gdb-tips/print-registers.html">è¿™é‡Œ</a>.å®éªŒå¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/wuhualong/p/lab01_exercise10_test_backtrace.html">è¿™é‡Œ</a>.</p>

<p>é€šè¿‡kernel.asmå¯ä»¥æ‰¾åˆ°,æ¯æ¬¡ä¼šæŠŠeip,ebp,ebx,esiå‹å…¥æ ˆä¸­,å®ƒä»¬éƒ½æ˜¯32bitçš„.%espå­˜å‚¨æ ˆé¡¶çš„ä½ç½®ï¼Œ%ebpå­˜å‚¨è°ƒç”¨è€…æ ˆé¡¶çš„ä½ç½®ï¼Œ%eaxå­˜å‚¨xçš„å€¼,%eipå­˜æ”¾ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å†…å­˜åœ°å€,eipçš„å€¼æ˜¯callæŒ‡ä»¤æ‰§è¡Œæ—¶å‹æ ˆçš„.</p>

<h2 id="exercise-11">Exercise 11</h2>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Exercise 11. Implement the backtrace function as specified above. Use the same format as in the example, since otherwise the grading script will be confused. When you think you have it working right, run make grade to see if its output conforms to what our grading script expects, and fix it if it doesn't. After you have handed in your Lab 1 code, you are welcome to change the output format of the backtrace function any way you like.

If you use read_ebp(), note that GCC may generate "optimized" code that calls read_ebp() before mon_backtrace()'s function prologue, which results in an incomplete stack trace (the stack frame of the most recent function call is missing). While we have tried to disable optimizations that cause this reordering, you may want to examine the assembly of mon_backtrace() and make sure the call to read_ebp() is happening after the function prologue.
</code></pre></div></div>

<p>è§£ç­”:</p>

<p>æ¯ä¸ªtest_backtraceå‡½æ•°çš„è°ƒç”¨ä¼šåˆ›å»ºä¸€ä¸ªç›¸åŒçš„æ ˆ.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>args[4]
args[3]
args[2]
args[1]
args[0]
eip
ebp
</code></pre></div></div>

<p>æ‰€ä»¥å¯ä»¥æ ¹æ®è¿™ä¸ªå†™è¿™æ ·çš„ä»£ç .</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">mon_backtrace</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Trapframe</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">ebp</span> <span class="o">=</span> <span class="n">read_ebp</span><span class="p">();</span>
    <span class="kt">uint32_t</span> <span class="n">eip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cp">#define TO_INT(x)  *((uint32_t*)(x))
</span>    <span class="k">while</span> <span class="p">(</span><span class="n">ebp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">eip</span> <span class="o">=</span> <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>
        <span class="n">cprintf</span><span class="p">(</span><span class="s">"ebp %08x  eip %08x  args %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">ebp</span><span class="p">,</span>                <span class="cm">/*ebp*/</span>
                <span class="n">eip</span><span class="p">,</span>                <span class="cm">/*eip*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="p">)),</span>    <span class="cm">/*arg1*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">12</span><span class="p">)),</span>   <span class="cm">/*arg2*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">16</span><span class="p">)),</span>   <span class="cm">/*arg3*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">20</span><span class="p">)),</span>   <span class="cm">/*arg4*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">24</span><span class="p">)));</span>  <span class="cm">/*arg5*/</span>

        <span class="n">ebp</span> <span class="o">=</span> <span class="n">TO_INT</span><span class="p">(</span><span class="n">ebp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="exercise-12">Exercise 12</h2>

<p>è§£ç­”:</p>

<p>æ˜¯å¦æœ‰åŠ è½½ç¬¦å·è¡¨,å¯ä»¥åœ¨å†…æ ¸è¿›å…¥ç‚¹0x10000cå¤„è®¾ç½®æ–­ç‚¹.ç„¶åä½¿ç”¨å‘½ä»¤<code class="language-plaintext highlighter-rouge">x/8s stabstr_begin</code>å¯ä»¥æŸ¥çœ‹,stab_beginæ˜¯ä½ çš„stabstræ®µçš„å¼€å§‹åœ°å€,stabstræ®µçš„å¼€å§‹åœ°å€å¯ä»¥ä½¿ç”¨å‘½ä»¤<code class="language-plaintext highlighter-rouge">objdump -h obj/kern/kernel</code>æŸ¥çœ‹,stabstræ®µçš„VMAçš„å€¼å°±æ˜¯å¼€å§‹åœ°å€,æˆ‘çš„æ“ä½œå¦‚ä¸‹:</p>

<p><img src="/assets/images/posts/2019-06-17-6.828 lec1/06.png" alt="" /></p>

<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºå·²ç»åŠ è½½äº†ç¬¦å·è¡¨.é€šè¿‡<code class="language-plaintext highlighter-rouge">objdump -G obj/kern/kernel</code>å¯ä»¥æŸ¥åˆ°ä¸‹é¢è¿™ç§ä¿¡æ¯ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Symnum n_type n_othr n_desc n_value  n_strx String
118    FUN    0      0      f01000a6 2987   i386_init:F<span class="o">(</span>0,25<span class="o">)</span>
119    SLINE  0      24     00000000 0
120    SLINE  0      34     00000012 0
121    SLINE  0      36     00000017 0
122    SLINE  0      39     0000002b 0
123    SLINE  0      43     0000003a 0  
</code></pre></div></div>

<p>stabçš„è§£é‡Šå¯ä»¥æŸ¥çœ‹<a href="https://www.cnblogs.com/wuhualong/p/lab01_exercise12_print_more_info.html">è¿™é‡Œ</a></p>

<p>åœ¨stab tableå’Œstabstr tableä¸­ï¼Œä¿å­˜æœ‰å¯¹åº”è™šæ‹Ÿåœ°å€åœ¨é‚£ä¸ªæ–‡ä»¶ä¸­ï¼Œé‚£ä¸ªå‡½æ•°ï¼Œé‚£ä¸€è¡Œï¼Œå·²ç»æ±‡ç¼–æ ¼å¼çš„offsetã€‚åœ¨è°ƒç”¨<code class="language-plaintext highlighter-rouge">debuginfo_eip(eip, &amp;info)</code>æ—¶ï¼Œä¼ å…¥äº†ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œæ ¹æ®è¿™ä¸ªè™šæ‹Ÿåœ°å€ï¼Œé¦–å…ˆæŸ¥æ‰¾stab tableä¸­çš„<code class="language-plaintext highlighter-rouge">N_SO(æºæ–‡ä»¶ç±»å‹)</code>,é€šè¿‡äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œå°±å¯ä»¥é”å®šè™šæ‹Ÿåœ°å€åœ¨stabä¸­çš„èŒƒå›´.ç„¶ååˆåœ¨è¿™ä¸ªèŒƒå›´ä¸­æŸ¥æ‰¾<code class="language-plaintext highlighter-rouge">N_FUN</code>ç±»å‹ï¼Œå¯ä»¥ç»§ç»­ç¼©å°èŒƒå›´ï¼Œå†é€šè¿‡<code class="language-plaintext highlighter-rouge">N_SLINE</code>ç±»å‹å’Œè™šæ‹Ÿåœ°å€æ‰¾åˆ°ç¡®å®šçš„ä¸€è¡Œï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°è¿™è¡Œä»£ç çš„å…·ä½“ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä»£ç æ‰€åœ¨çš„æ–‡ä»¶ï¼Œå‡½æ•°ï¼Œè¡Œå·ï¼Œä»¥åŠé€šè¿‡è®¡ç®—å¯ä»¥å¾—åˆ°offsetã€‚</p>

<p>debuginfo_eipå‡½æ•°è¦è¡¥å……çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stab_binsearch</span><span class="p">(</span><span class="n">stabs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lline</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rline</span><span class="p">,</span> <span class="n">N_SLINE</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">lfun</span> <span class="o">&lt;=</span> <span class="n">rfun</span><span class="p">)</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">eip_line</span> <span class="o">=</span> <span class="n">stabs</span><span class="p">[</span><span class="n">lline</span><span class="p">].</span><span class="n">n_desc</span><span class="p">;</span>
<span class="k">else</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>mon_backtraceå‡½æ•°è¢«ä¿®æ”¹æˆå¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">mon_backtrace</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Trapframe</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">ebp</span> <span class="o">=</span> <span class="n">read_ebp</span><span class="p">();</span>
    <span class="kt">uint32_t</span> <span class="n">eip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">Eipdebuginfo</span> <span class="n">info</span><span class="p">;</span>
    <span class="cp">#define TO_INT(x)  *((uint32_t*)(x))
</span>    <span class="k">while</span> <span class="p">(</span><span class="n">ebp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">eip</span> <span class="o">=</span> <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>
        <span class="n">cprintf</span><span class="p">(</span><span class="s">"ebp %08x  eip %08x  args %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">ebp</span><span class="p">,</span>                <span class="cm">/*ebp*/</span>
                <span class="n">eip</span><span class="p">,</span>                <span class="cm">/*eip*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="p">)),</span>    <span class="cm">/*arg1*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">12</span><span class="p">)),</span>   <span class="cm">/*arg2*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">16</span><span class="p">)),</span>   <span class="cm">/*arg3*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">20</span><span class="p">)),</span>   <span class="cm">/*arg4*/</span>
                <span class="n">TO_INT</span><span class="p">((</span><span class="n">ebp</span><span class="o">+</span><span class="mi">24</span><span class="p">)));</span>  <span class="cm">/*arg5*/</span>

        <span class="k">if</span><span class="p">(</span><span class="n">debuginfo_eip</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cprintf</span><span class="p">(</span><span class="s">"%s:%d: "</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_file</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_line</span><span class="p">);</span>
            <span class="n">cprintf</span><span class="p">(</span><span class="s">"%.*s"</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_fn_namelen</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_fn_name</span><span class="p">);</span>
            <span class="n">cprintf</span><span class="p">(</span><span class="s">"+%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">eip</span> <span class="o">-</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_fn_addr</span><span class="p">);</span> <span class="c1">//å‡½æ•°é¦–åœ°å€ - è™šæ‹Ÿåœ°å€ = offset</span>
        <span class="p">}</span> <span class="c1">// eip = *(ebp+1)</span>
        <span class="n">ebp</span> <span class="o">=</span> <span class="n">TO_INT</span><span class="p">(</span><span class="n">ebp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸€é¢˜æœ‰ç‚¹å¤æ‚,å¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/wuhualong/p/lab01_exercise12_print_more_info.html">è¿™é‡Œ</a></p>

<p>æœ€åå¼ºçƒˆæ¨è<a href="https://www.cnblogs.com/wuhualong/p/mit_6-828_lab1.html">è¿™ä¸ª</a></p>

<p><a href="http://www.voidcn.com/article/p-otgxarrw-ro.html">xv6 lab1 å­¦ä¹ </a></p>
:ET